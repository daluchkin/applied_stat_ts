<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 8 Missing values, anomalies, structural shift | Applied statistics: Time series analysis</title>
  <meta name="description" content="Chapter 8 Missing values, anomalies, structural shift | Applied statistics: Time series analysis" />
  <meta name="generator" content="bookdown 0.41 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 8 Missing values, anomalies, structural shift | Applied statistics: Time series analysis" />
  <meta property="og:type" content="book" />
  
  
  <meta name="github-repo" content="https://github.com/daluchkin/applied_stat_ts" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 8 Missing values, anomalies, structural shift | Applied statistics: Time series analysis" />
  
  
  

<meta name="author" content="Dmitry Luchkin" />


<meta name="date" content="2024-12-13" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="arima-with-predictors.html"/>
<link rel="next" href="questions-and-answers.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="https://www.youtube.com/@%D0%9F%D1%80%D0%B8%D0%BA%D0%BB%D0%B0%D0%B4%D0%BD%D0%B0%D1%8F%D1%81%D1%82%D0%B0%D1%82%D0%B8%D1%81%D1%82%D0%B8%D0%BA%D0%B0/playlists">Time Series Analysis</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a></li>
<li class="chapter" data-level="1" data-path="components-of-time-series-and-naive-models.html"><a href="components-of-time-series-and-naive-models.html"><i class="fa fa-check"></i><b>1</b> Components of time series and naive models</a>
<ul>
<li class="chapter" data-level="1.1" data-path="components-of-time-series-and-naive-models.html"><a href="components-of-time-series-and-naive-models.html#what-is-time-series"><i class="fa fa-check"></i><b>1.1</b> What is time series?</a></li>
<li class="chapter" data-level="1.2" data-path="components-of-time-series-and-naive-models.html"><a href="components-of-time-series-and-naive-models.html#time-series-components"><i class="fa fa-check"></i><b>1.2</b> Time Series Components</a></li>
<li class="chapter" data-level="1.3" data-path="components-of-time-series-and-naive-models.html"><a href="components-of-time-series-and-naive-models.html#algorithm-stl"><i class="fa fa-check"></i><b>1.3</b> Algorithm STL</a></li>
<li class="chapter" data-level="1.4" data-path="components-of-time-series-and-naive-models.html"><a href="components-of-time-series-and-naive-models.html#time-series-characteristics"><i class="fa fa-check"></i><b>1.4</b> Time Series Characteristics</a>
<ul>
<li class="chapter" data-level="" data-path="components-of-time-series-and-naive-models.html"><a href="components-of-time-series-and-naive-models.html#acf"><i class="fa fa-check"></i>ACF</a></li>
<li class="chapter" data-level="" data-path="components-of-time-series-and-naive-models.html"><a href="components-of-time-series-and-naive-models.html#pacf"><i class="fa fa-check"></i>PACF</a></li>
</ul></li>
<li class="chapter" data-level="1.5" data-path="components-of-time-series-and-naive-models.html"><a href="components-of-time-series-and-naive-models.html#simple-models"><i class="fa fa-check"></i><b>1.5</b> Simple Models</a>
<ul>
<li class="chapter" data-level="" data-path="components-of-time-series-and-naive-models.html"><a href="components-of-time-series-and-naive-models.html#white-noise"><i class="fa fa-check"></i>White Noise</a></li>
<li class="chapter" data-level="" data-path="components-of-time-series-and-naive-models.html"><a href="components-of-time-series-and-naive-models.html#model-with-independent-observations"><i class="fa fa-check"></i>Model with independent observations</a></li>
<li class="chapter" data-level="" data-path="components-of-time-series-and-naive-models.html"><a href="components-of-time-series-and-naive-models.html#naive-model-random-walk"><i class="fa fa-check"></i>Naive Model (Random Walk)</a></li>
<li class="chapter" data-level="" data-path="components-of-time-series-and-naive-models.html"><a href="components-of-time-series-and-naive-models.html#seasonal-random-walk"><i class="fa fa-check"></i>Seasonal Random Walk</a></li>
</ul></li>
<li class="chapter" data-level="1.6" data-path="components-of-time-series-and-naive-models.html"><a href="components-of-time-series-and-naive-models.html#examples"><i class="fa fa-check"></i><b>1.6</b> Examples</a>
<ul>
<li class="chapter" data-level="1.6.1" data-path="components-of-time-series-and-naive-models.html"><a href="components-of-time-series-and-naive-models.html#time-series-from-scratch"><i class="fa fa-check"></i><b>1.6.1</b> Time series from scratch</a></li>
<li class="chapter" data-level="1.6.2" data-path="components-of-time-series-and-naive-models.html"><a href="components-of-time-series-and-naive-models.html#time-series-data-cleaning"><i class="fa fa-check"></i><b>1.6.2</b> Time Series data cleaning</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="2" data-path="exponential-smoothing-models.html"><a href="exponential-smoothing-models.html"><i class="fa fa-check"></i><b>2</b> Exponential smoothing models</a>
<ul>
<li class="chapter" data-level="2.1" data-path="exponential-smoothing-models.html"><a href="exponential-smoothing-models.html#etsann-model"><i class="fa fa-check"></i><b>2.1</b> ETS(ANN) model</a>
<ul>
<li class="chapter" data-level="2.1.1" data-path="exponential-smoothing-models.html"><a href="exponential-smoothing-models.html#forecast"><i class="fa fa-check"></i><b>2.1.1</b> Forecast</a></li>
<li class="chapter" data-level="2.1.2" data-path="exponential-smoothing-models.html"><a href="exponential-smoothing-models.html#example"><i class="fa fa-check"></i><b>2.1.2</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="2.2" data-path="exponential-smoothing-models.html"><a href="exponential-smoothing-models.html#etsaan-model"><i class="fa fa-check"></i><b>2.2</b> ETS(AAN) model</a>
<ul>
<li class="chapter" data-level="2.2.1" data-path="exponential-smoothing-models.html"><a href="exponential-smoothing-models.html#forecast-1"><i class="fa fa-check"></i><b>2.2.1</b> Forecast</a></li>
<li class="chapter" data-level="2.2.2" data-path="exponential-smoothing-models.html"><a href="exponential-smoothing-models.html#example-1"><i class="fa fa-check"></i><b>2.2.2</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="2.3" data-path="exponential-smoothing-models.html"><a href="exponential-smoothing-models.html#etsaaa-model"><i class="fa fa-check"></i><b>2.3</b> ETS(AAA) model</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="exponential-smoothing-models.html"><a href="exponential-smoothing-models.html#forecast-2"><i class="fa fa-check"></i><b>2.3.1</b> Forecast</a></li>
<li class="chapter" data-level="2.3.2" data-path="exponential-smoothing-models.html"><a href="exponential-smoothing-models.html#example-2"><i class="fa fa-check"></i><b>2.3.2</b> Example</a></li>
</ul></li>
<li class="chapter" data-level="2.4" data-path="exponential-smoothing-models.html"><a href="exponential-smoothing-models.html#model-selection"><i class="fa fa-check"></i><b>2.4</b> Model selection</a>
<ul>
<li class="chapter" data-level="" data-path="exponential-smoothing-models.html"><a href="exponential-smoothing-models.html#mean-absolute-error"><i class="fa fa-check"></i>Mean Absolute Error</a></li>
<li class="chapter" data-level="" data-path="exponential-smoothing-models.html"><a href="exponential-smoothing-models.html#root-mean-squared-error"><i class="fa fa-check"></i>Root Mean Squared Error</a></li>
<li class="chapter" data-level="" data-path="exponential-smoothing-models.html"><a href="exponential-smoothing-models.html#mean-absolute-percentage-error"><i class="fa fa-check"></i>Mean Absolute Percentage Error</a></li>
<li class="chapter" data-level="" data-path="exponential-smoothing-models.html"><a href="exponential-smoothing-models.html#symmetric-mean-absolute-percentage-error"><i class="fa fa-check"></i>Symmetric Mean Absolute Percentage Error</a></li>
<li class="chapter" data-level="" data-path="exponential-smoothing-models.html"><a href="exponential-smoothing-models.html#mean-absolute-scaled-error"><i class="fa fa-check"></i>Mean Absolute Scaled Error</a></li>
<li class="chapter" data-level="" data-path="exponential-smoothing-models.html"><a href="exponential-smoothing-models.html#akaike-information-criterion"><i class="fa fa-check"></i>Akaike Information Criterion</a></li>
</ul></li>
<li class="chapter" data-level="2.5" data-path="exponential-smoothing-models.html"><a href="exponential-smoothing-models.html#examples-1"><i class="fa fa-check"></i><b>2.5</b> Examples</a>
<ul>
<li class="chapter" data-level="2.5.1" data-path="exponential-smoothing-models.html"><a href="exponential-smoothing-models.html#model-selection-by-mse"><i class="fa fa-check"></i><b>2.5.1</b> Model selection by MSE</a></li>
<li class="chapter" data-level="2.5.2" data-path="exponential-smoothing-models.html"><a href="exponential-smoothing-models.html#model-averaging"><i class="fa fa-check"></i><b>2.5.2</b> Model Averaging</a></li>
<li class="chapter" data-level="2.5.3" data-path="exponential-smoothing-models.html"><a href="exponential-smoothing-models.html#cross-validation"><i class="fa fa-check"></i><b>2.5.3</b> Cross-validation</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="3" data-path="ets-model-variations.html"><a href="ets-model-variations.html"><i class="fa fa-check"></i><b>3</b> ETS model variations</a>
<ul>
<li class="chapter" data-level="3.1" data-path="ets-model-variations.html"><a href="ets-model-variations.html#etsaadn-damped-trend"><i class="fa fa-check"></i><b>3.1</b> ETS(AAdN): damped trend</a>
<ul>
<li class="chapter" data-level="" data-path="ets-model-variations.html"><a href="ets-model-variations.html#forecast-3"><i class="fa fa-check"></i>Forecast</a></li>
<li class="chapter" data-level="" data-path="ets-model-variations.html"><a href="ets-model-variations.html#example-3"><i class="fa fa-check"></i>Example</a></li>
</ul></li>
<li class="chapter" data-level="3.2" data-path="ets-model-variations.html"><a href="ets-model-variations.html#etsmnm-multiplicative-components"><i class="fa fa-check"></i><b>3.2</b> ETS(MNM): multiplicative components</a>
<ul>
<li class="chapter" data-level="" data-path="ets-model-variations.html"><a href="ets-model-variations.html#parameters"><i class="fa fa-check"></i>Parameters</a></li>
<li class="chapter" data-level="" data-path="ets-model-variations.html"><a href="ets-model-variations.html#forecast-4"><i class="fa fa-check"></i>Forecast</a></li>
<li class="chapter" data-level="" data-path="ets-model-variations.html"><a href="ets-model-variations.html#example-4"><i class="fa fa-check"></i>Example</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="ets-model-variations.html"><a href="ets-model-variations.html#etsmadm-combinations"><i class="fa fa-check"></i><b>3.3</b> ETS(MAdM): combinations</a>
<ul>
<li class="chapter" data-level="" data-path="ets-model-variations.html"><a href="ets-model-variations.html#parameters-1"><i class="fa fa-check"></i>Parameters</a></li>
<li class="chapter" data-level="" data-path="ets-model-variations.html"><a href="ets-model-variations.html#forecast-5"><i class="fa fa-check"></i>Forecast</a></li>
<li class="chapter" data-level="" data-path="ets-model-variations.html"><a href="ets-model-variations.html#example-5"><i class="fa fa-check"></i>Example</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="ets-model-variations.html"><a href="ets-model-variations.html#examples-2"><i class="fa fa-check"></i><b>3.4</b> Examples</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="stationary-process.html"><a href="stationary-process.html"><i class="fa fa-check"></i><b>4</b> Stationary Process</a>
<ul>
<li class="chapter" data-level="4.1" data-path="stationary-process.html"><a href="stationary-process.html#ma-processes"><i class="fa fa-check"></i><b>4.1</b> MA processes</a></li>
<li class="chapter" data-level="4.2" data-path="stationary-process.html"><a href="stationary-process.html#examples-3"><i class="fa fa-check"></i><b>4.2</b> Examples</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="arma-processes.html"><a href="arma-processes.html"><i class="fa fa-check"></i><b>5</b> ARMA processes</a>
<ul>
<li class="chapter" data-level="5.1" data-path="arma-processes.html"><a href="arma-processes.html#ar-process"><i class="fa fa-check"></i><b>5.1</b> AR process</a></li>
<li class="chapter" data-level="5.2" data-path="arma-processes.html"><a href="arma-processes.html#arma-process"><i class="fa fa-check"></i><b>5.2</b> ARMA process</a></li>
<li class="chapter" data-level="5.3" data-path="arma-processes.html"><a href="arma-processes.html#examples-4"><i class="fa fa-check"></i><b>5.3</b> Examples</a></li>
<li class="chapter" data-level="5.4" data-path="arma-processes.html"><a href="arma-processes.html#comparing-ar-ma-and-arma"><i class="fa fa-check"></i><b>5.4</b> Comparing AR, MA and ARMA</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="arima-and-seasonal-arima-sarima.html"><a href="arima-and-seasonal-arima-sarima.html"><i class="fa fa-check"></i><b>6</b> ARIMA and seasonal ARIMA (sARIMA)</a>
<ul>
<li class="chapter" data-level="6.1" data-path="arima-and-seasonal-arima-sarima.html"><a href="arima-and-seasonal-arima-sarima.html#unit-root-test"><i class="fa fa-check"></i><b>6.1</b> Unit root test</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="arima-and-seasonal-arima-sarima.html"><a href="arima-and-seasonal-arima-sarima.html#kpss-test"><i class="fa fa-check"></i><b>6.1.1</b> KPSS test</a></li>
<li class="chapter" data-level="6.1.2" data-path="arima-and-seasonal-arima-sarima.html"><a href="arima-and-seasonal-arima-sarima.html#adf-test"><i class="fa fa-check"></i><b>6.1.2</b> ADF test</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="arima-and-seasonal-arima-sarima.html"><a href="arima-and-seasonal-arima-sarima.html#seasonal-arima"><i class="fa fa-check"></i><b>6.2</b> Seasonal ARIMA</a>
<ul>
<li class="chapter" data-level="" data-path="arima-and-seasonal-arima-sarima.html"><a href="arima-and-seasonal-arima-sarima.html#step-1-how-many-times-should-i-apply-a-seasonal-differencing"><i class="fa fa-check"></i><strong>Step 1</strong>: How many times should I apply a seasonal differencing?</a></li>
<li class="chapter" data-level="" data-path="arima-and-seasonal-arima-sarima.html"><a href="arima-and-seasonal-arima-sarima.html#step-2-how-many-times-should-i-apply-a-first-differencing"><i class="fa fa-check"></i><strong>Step 2</strong>: How many times should I apply a first differencing?</a></li>
<li class="chapter" data-level="" data-path="arima-and-seasonal-arima-sarima.html"><a href="arima-and-seasonal-arima-sarima.html#step-3-apply-sarma-models-to-stationary-series."><i class="fa fa-check"></i><strong>Step 3</strong>: Apply SARMA models to stationary series.</a></li>
</ul></li>
<li class="chapter" data-level="6.3" data-path="arima-and-seasonal-arima-sarima.html"><a href="arima-and-seasonal-arima-sarima.html#automatic-arima"><i class="fa fa-check"></i><b>6.3</b> Automatic ARIMA</a></li>
<li class="chapter" data-level="6.4" data-path="arima-and-seasonal-arima-sarima.html"><a href="arima-and-seasonal-arima-sarima.html#output2equations"><i class="fa fa-check"></i><b>6.4</b> Output2Equations</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="arima-with-predictors.html"><a href="arima-with-predictors.html"><i class="fa fa-check"></i><b>7</b> ARIMA with predictors</a>
<ul>
<li class="chapter" data-level="7.1" data-path="arima-with-predictors.html"><a href="arima-with-predictors.html#how-to-make-predictors"><i class="fa fa-check"></i><b>7.1</b> How to make predictors?</a></li>
<li class="chapter" data-level="7.2" data-path="arima-with-predictors.html"><a href="arima-with-predictors.html#using-lags"><i class="fa fa-check"></i><b>7.2</b> Using lags</a></li>
<li class="chapter" data-level="7.3" data-path="arima-with-predictors.html"><a href="arima-with-predictors.html#using-function-of-lags"><i class="fa fa-check"></i><b>7.3</b> Using function of lags</a></li>
<li class="chapter" data-level="7.4" data-path="arima-with-predictors.html"><a href="arima-with-predictors.html#time-predictors"><i class="fa fa-check"></i><b>7.4</b> Time predictors</a></li>
<li class="chapter" data-level="7.5" data-path="arima-with-predictors.html"><a href="arima-with-predictors.html#trend-predictors"><i class="fa fa-check"></i><b>7.5</b> Trend predictors</a></li>
<li class="chapter" data-level="7.6" data-path="arima-with-predictors.html"><a href="arima-with-predictors.html#seasonal-and-holidays-dummies"><i class="fa fa-check"></i><b>7.6</b> Seasonal and holidays dummies</a></li>
<li class="chapter" data-level="7.7" data-path="arima-with-predictors.html"><a href="arima-with-predictors.html#sin-and-cos-over-time"><i class="fa fa-check"></i><b>7.7</b> Sin and Cos over time</a></li>
<li class="chapter" data-level="7.8" data-path="arima-with-predictors.html"><a href="arima-with-predictors.html#arima-and-predictors"><i class="fa fa-check"></i><b>7.8</b> ARIMA and predictors</a>
<ul>
<li class="chapter" data-level="7.8.1" data-path="arima-with-predictors.html"><a href="arima-with-predictors.html#example-1-1"><i class="fa fa-check"></i><b>7.8.1</b> Example 1</a></li>
<li class="chapter" data-level="7.8.2" data-path="arima-with-predictors.html"><a href="arima-with-predictors.html#example-2.-daily-data"><i class="fa fa-check"></i><b>7.8.2</b> Example 2. Daily data</a></li>
<li class="chapter" data-level="7.8.3" data-path="arima-with-predictors.html"><a href="arima-with-predictors.html#example-3-1"><i class="fa fa-check"></i><b>7.8.3</b> Example 3</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="8" data-path="missing-values-anomalies-structural-shift.html"><a href="missing-values-anomalies-structural-shift.html"><i class="fa fa-check"></i><b>8</b> Missing values, anomalies, structural shift</a>
<ul>
<li class="chapter" data-level="8.1" data-path="missing-values-anomalies-structural-shift.html"><a href="missing-values-anomalies-structural-shift.html#missing-values"><i class="fa fa-check"></i><b>8.1</b> Missing values</a>
<ul>
<li class="chapter" data-level="8.1.1" data-path="missing-values-anomalies-structural-shift.html"><a href="missing-values-anomalies-structural-shift.html#imputation-with-linear-interpolation"><i class="fa fa-check"></i><b>8.1.1</b> Imputation with linear interpolation</a></li>
<li class="chapter" data-level="8.1.2" data-path="missing-values-anomalies-structural-shift.html"><a href="missing-values-anomalies-structural-shift.html#arima-imputation"><i class="fa fa-check"></i><b>8.1.2</b> ARIMA imputation</a></li>
<li class="chapter" data-level="8.1.3" data-path="missing-values-anomalies-structural-shift.html"><a href="missing-values-anomalies-structural-shift.html#imputation-with-stl-decomposition"><i class="fa fa-check"></i><b>8.1.3</b> Imputation with STL decomposition</a></li>
</ul></li>
<li class="chapter" data-level="8.2" data-path="missing-values-anomalies-structural-shift.html"><a href="missing-values-anomalies-structural-shift.html#outliers-and-anomalies"><i class="fa fa-check"></i><b>8.2</b> Outliers and anomalies</a></li>
<li class="chapter" data-level="8.3" data-path="missing-values-anomalies-structural-shift.html"><a href="missing-values-anomalies-structural-shift.html#structural-shift"><i class="fa fa-check"></i><b>8.3</b> Structural shift</a></li>
<li class="chapter" data-level="8.4" data-path="missing-values-anomalies-structural-shift.html"><a href="missing-values-anomalies-structural-shift.html#bayesian-structural-model"><i class="fa fa-check"></i><b>8.4</b> Bayesian Structural Model</a></li>
<li class="chapter" data-level="8.5" data-path="missing-values-anomalies-structural-shift.html"><a href="missing-values-anomalies-structural-shift.html#causal-impact"><i class="fa fa-check"></i><b>8.5</b> Causal impact</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="questions-and-answers.html"><a href="questions-and-answers.html"><i class="fa fa-check"></i><b>9</b> Questions and answers</a>
<ul>
<li class="chapter" data-level="9.1" data-path="questions-and-answers.html"><a href="questions-and-answers.html#multiseasonality"><i class="fa fa-check"></i><b>9.1</b> Multiseasonality</a></li>
<li class="chapter" data-level="9.2" data-path="questions-and-answers.html"><a href="questions-and-answers.html#crostons-algorithm"><i class="fa fa-check"></i><b>9.2</b> Croston’s Algorithm</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/daluchkin?tab=repositories">All Repositories</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Applied statistics: Time series analysis</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="missing-values-anomalies-structural-shift" class="section level1 hasAnchor" number="8">
<h1><span class="header-section-number">Chapter 8</span> Missing values, anomalies, structural shift<a href="missing-values-anomalies-structural-shift.html#missing-values-anomalies-structural-shift" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div class="sourceCode" id="cb286"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb286-1"><a href="missing-values-anomalies-structural-shift.html#cb286-1" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb286-2"><a href="missing-values-anomalies-structural-shift.html#cb286-2" tabindex="-1"></a><span class="fu">library</span>(fpp3)</span>
<span id="cb286-3"><a href="missing-values-anomalies-structural-shift.html#cb286-3" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb286-4"><a href="missing-values-anomalies-structural-shift.html#cb286-4" tabindex="-1"></a><span class="fu">library</span>(rio)</span>
<span id="cb286-5"><a href="missing-values-anomalies-structural-shift.html#cb286-5" tabindex="-1"></a><span class="fu">library</span>(urca)</span>
<span id="cb286-6"><a href="missing-values-anomalies-structural-shift.html#cb286-6" tabindex="-1"></a><span class="fu">library</span>(imputeTS)</span></code></pre></div>
<div id="missing-values" class="section level2 hasAnchor" number="8.1">
<h2><span class="header-section-number">8.1</span> Missing values<a href="missing-values-anomalies-structural-shift.html#missing-values" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Data loading.</p>
<div class="sourceCode" id="cb287"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb287-1"><a href="missing-values-anomalies-structural-shift.html#cb287-1" tabindex="-1"></a>air <span class="ot">&lt;-</span> AirPassengers <span class="sc">|&gt;</span></span>
<span id="cb287-2"><a href="missing-values-anomalies-structural-shift.html#cb287-2" tabindex="-1"></a>  <span class="fu">as_tsibble</span>()</span>
<span id="cb287-3"><a href="missing-values-anomalies-structural-shift.html#cb287-3" tabindex="-1"></a></span>
<span id="cb287-4"><a href="missing-values-anomalies-structural-shift.html#cb287-4" tabindex="-1"></a>air <span class="sc">|&gt;</span></span>
<span id="cb287-5"><a href="missing-values-anomalies-structural-shift.html#cb287-5" tabindex="-1"></a>  <span class="fu">gg_tsdisplay</span>()</span></code></pre></div>
<pre><code>## Plot variable not specified, automatically selected `y = value`</code></pre>
<p><img src="_main_files/figure-html/08-missing-2-1.png" width="672" /></p>
<p>Create some NA’s.</p>
<div class="sourceCode" id="cb289"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb289-1"><a href="missing-values-anomalies-structural-shift.html#cb289-1" tabindex="-1"></a>lair <span class="ot">&lt;-</span> <span class="fu">log</span>(AirPassengers)</span>
<span id="cb289-2"><a href="missing-values-anomalies-structural-shift.html#cb289-2" tabindex="-1"></a>lair_na <span class="ot">&lt;-</span> lair</span>
<span id="cb289-3"><a href="missing-values-anomalies-structural-shift.html#cb289-3" tabindex="-1"></a>where_na <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">5</span><span class="sc">:</span><span class="dv">6</span>, <span class="dv">30</span><span class="sc">:</span><span class="dv">32</span>, <span class="dv">70</span>, <span class="dv">90</span><span class="sc">:</span><span class="dv">91</span>, <span class="dv">110</span>, <span class="dv">124</span>)</span>
<span id="cb289-4"><a href="missing-values-anomalies-structural-shift.html#cb289-4" tabindex="-1"></a></span>
<span id="cb289-5"><a href="missing-values-anomalies-structural-shift.html#cb289-5" tabindex="-1"></a>lair_na[where_na] <span class="ot">&lt;-</span> <span class="cn">NA</span></span></code></pre></div>
<p>Plot NA’s.</p>
<div class="sourceCode" id="cb290"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb290-1"><a href="missing-values-anomalies-structural-shift.html#cb290-1" tabindex="-1"></a><span class="fu">ggplot_na_distribution</span>(lair_na)</span></code></pre></div>
<p><img src="_main_files/figure-html/08-missing-4-1.png" width="672" /></p>
<div class="sourceCode" id="cb291"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb291-1"><a href="missing-values-anomalies-structural-shift.html#cb291-1" tabindex="-1"></a><span class="fu">ggplot_na_distribution2</span>(lair_na)</span></code></pre></div>
<p><img src="_main_files/figure-html/08-missing-5-1.png" width="672" /></p>
<div id="imputation-with-linear-interpolation" class="section level3 hasAnchor" number="8.1.1">
<h3><span class="header-section-number">8.1.1</span> Imputation with linear interpolation<a href="missing-values-anomalies-structural-shift.html#imputation-with-linear-interpolation" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb292"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb292-1"><a href="missing-values-anomalies-structural-shift.html#cb292-1" tabindex="-1"></a><span class="co"># linear interpolation</span></span>
<span id="cb292-2"><a href="missing-values-anomalies-structural-shift.html#cb292-2" tabindex="-1"></a></span>
<span id="cb292-3"><a href="missing-values-anomalies-structural-shift.html#cb292-3" tabindex="-1"></a>lair_int <span class="ot">&lt;-</span> <span class="fu">na_interpolation</span>(lair_na)</span>
<span id="cb292-4"><a href="missing-values-anomalies-structural-shift.html#cb292-4" tabindex="-1"></a></span>
<span id="cb292-5"><a href="missing-values-anomalies-structural-shift.html#cb292-5" tabindex="-1"></a><span class="fu">ggplot_na_imputations</span>(lair_na, lair_int, lair)</span></code></pre></div>
<p><img src="_main_files/figure-html/08-missing-6-1.png" width="672" /></p>
</div>
<div id="arima-imputation" class="section level3 hasAnchor" number="8.1.2">
<h3><span class="header-section-number">8.1.2</span> ARIMA imputation<a href="missing-values-anomalies-structural-shift.html#arima-imputation" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb293"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb293-1"><a href="missing-values-anomalies-structural-shift.html#cb293-1" tabindex="-1"></a><span class="co"># ARIMA imputation</span></span>
<span id="cb293-2"><a href="missing-values-anomalies-structural-shift.html#cb293-2" tabindex="-1"></a></span>
<span id="cb293-3"><a href="missing-values-anomalies-structural-shift.html#cb293-3" tabindex="-1"></a>mod <span class="ot">&lt;-</span> <span class="fu">arima</span>(lair_na, <span class="at">order =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">0</span>), <span class="at">seasonal =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">0</span>))<span class="sc">$</span>model</span>
<span id="cb293-4"><a href="missing-values-anomalies-structural-shift.html#cb293-4" tabindex="-1"></a></span>
<span id="cb293-5"><a href="missing-values-anomalies-structural-shift.html#cb293-5" tabindex="-1"></a>lair_arima <span class="ot">&lt;-</span> <span class="fu">na_kalman</span>(lair_na, <span class="at">model =</span> mod)</span>
<span id="cb293-6"><a href="missing-values-anomalies-structural-shift.html#cb293-6" tabindex="-1"></a>lair_arima.auto <span class="ot">&lt;-</span> <span class="fu">na_kalman</span>(lair_na, <span class="at">model =</span> <span class="st">&#39;auto.arima&#39;</span>)</span>
<span id="cb293-7"><a href="missing-values-anomalies-structural-shift.html#cb293-7" tabindex="-1"></a></span>
<span id="cb293-8"><a href="missing-values-anomalies-structural-shift.html#cb293-8" tabindex="-1"></a><span class="fu">ggplot_na_imputations</span>(lair_na, lair_arima.auto, lair)</span></code></pre></div>
<p><img src="_main_files/figure-html/08-missing-7-1.png" width="672" /></p>
</div>
<div id="imputation-with-stl-decomposition" class="section level3 hasAnchor" number="8.1.3">
<h3><span class="header-section-number">8.1.3</span> Imputation with STL decomposition<a href="missing-values-anomalies-structural-shift.html#imputation-with-stl-decomposition" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<div class="sourceCode" id="cb294"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb294-1"><a href="missing-values-anomalies-structural-shift.html#cb294-1" tabindex="-1"></a><span class="co"># STL decomposition</span></span>
<span id="cb294-2"><a href="missing-values-anomalies-structural-shift.html#cb294-2" tabindex="-1"></a></span>
<span id="cb294-3"><a href="missing-values-anomalies-structural-shift.html#cb294-3" tabindex="-1"></a>lair_seas <span class="ot">&lt;-</span> <span class="fu">na_seadec</span>(lair_na)</span>
<span id="cb294-4"><a href="missing-values-anomalies-structural-shift.html#cb294-4" tabindex="-1"></a><span class="fu">ggplot_na_imputations</span>(lair_na, lair_seas, lair)</span></code></pre></div>
<p><img src="_main_files/figure-html/08-missing-8-1.png" width="672" /></p>
</div>
</div>
<div id="outliers-and-anomalies" class="section level2 hasAnchor" number="8.2">
<h2><span class="header-section-number">8.2</span> Outliers and anomalies<a href="missing-values-anomalies-structural-shift.html#outliers-and-anomalies" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb295"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb295-1"><a href="missing-values-anomalies-structural-shift.html#cb295-1" tabindex="-1"></a><span class="fu">library</span>(anomalize)</span>
<span id="cb295-2"><a href="missing-values-anomalies-structural-shift.html#cb295-2" tabindex="-1"></a><span class="fu">library</span>(tibbletime)</span>
<span id="cb295-3"><a href="missing-values-anomalies-structural-shift.html#cb295-3" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span></code></pre></div>
<p>Make a table from <code>AirPAssenger</code>.</p>
<div class="sourceCode" id="cb296"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb296-1"><a href="missing-values-anomalies-structural-shift.html#cb296-1" tabindex="-1"></a>air <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">pass=</span>AirPassengers)</span>
<span id="cb296-2"><a href="missing-values-anomalies-structural-shift.html#cb296-2" tabindex="-1"></a></span>
<span id="cb296-3"><a href="missing-values-anomalies-structural-shift.html#cb296-3" tabindex="-1"></a><span class="fu">head</span>(air)</span></code></pre></div>
<pre><code>## # A tibble: 6 × 1
##    pass
##   &lt;dbl&gt;
## 1   112
## 2   118
## 3   132
## 4   129
## 5   121
## 6   135</code></pre>
<p>Add a new column for date.</p>
<div class="sourceCode" id="cb298"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb298-1"><a href="missing-values-anomalies-structural-shift.html#cb298-1" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">nrow</span>(air)</span>
<span id="cb298-2"><a href="missing-values-anomalies-structural-shift.html#cb298-2" tabindex="-1"></a>air2 <span class="ot">&lt;-</span> air <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">ymd</span>(<span class="st">&#39;1949-01-01&#39;</span>) <span class="sc">+</span> <span class="fu">months</span>(<span class="dv">0</span><span class="sc">:</span>(n<span class="dv">-1</span>)))</span>
<span id="cb298-3"><a href="missing-values-anomalies-structural-shift.html#cb298-3" tabindex="-1"></a></span>
<span id="cb298-4"><a href="missing-values-anomalies-structural-shift.html#cb298-4" tabindex="-1"></a>air2</span></code></pre></div>
<pre><code>## # A tibble: 144 × 2
##     pass date      
##    &lt;dbl&gt; &lt;date&gt;    
##  1   112 1949-01-01
##  2   118 1949-02-01
##  3   132 1949-03-01
##  4   129 1949-04-01
##  5   121 1949-05-01
##  6   135 1949-06-01
##  7   148 1949-07-01
##  8   148 1949-08-01
##  9   136 1949-09-01
## 10   119 1949-10-01
## # ℹ 134 more rows</code></pre>
<p>Plot the data.</p>
<div class="sourceCode" id="cb300"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb300-1"><a href="missing-values-anomalies-structural-shift.html#cb300-1" tabindex="-1"></a><span class="fu">qplot</span>(<span class="at">data=</span>air2, <span class="at">x =</span> date, <span class="at">y =</span> pass, <span class="at">geom =</span> <span class="st">&#39;line&#39;</span>)</span></code></pre></div>
<pre><code>## Don&#39;t know how to automatically pick scale for object of type &lt;ts&gt;. Defaulting to continuous.</code></pre>
<p><img src="_main_files/figure-html/08-missing-12-1.png" width="672" /></p>
<p>Make a log-transformation to stabilize the variance of the data.</p>
<div class="sourceCode" id="cb302"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb302-1"><a href="missing-values-anomalies-structural-shift.html#cb302-1" tabindex="-1"></a>air3 <span class="ot">&lt;-</span> air2 <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">ln_pass =</span> <span class="fu">log</span>(pass))</span>
<span id="cb302-2"><a href="missing-values-anomalies-structural-shift.html#cb302-2" tabindex="-1"></a>air3</span></code></pre></div>
<pre><code>## # A tibble: 144 × 3
##     pass date       ln_pass
##    &lt;dbl&gt; &lt;date&gt;       &lt;dbl&gt;
##  1   112 1949-01-01    4.72
##  2   118 1949-02-01    4.77
##  3   132 1949-03-01    4.88
##  4   129 1949-04-01    4.86
##  5   121 1949-05-01    4.80
##  6   135 1949-06-01    4.91
##  7   148 1949-07-01    5.00
##  8   148 1949-08-01    5.00
##  9   136 1949-09-01    4.91
## 10   119 1949-10-01    4.78
## # ℹ 134 more rows</code></pre>
<p>Plot the transformed data.</p>
<div class="sourceCode" id="cb304"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb304-1"><a href="missing-values-anomalies-structural-shift.html#cb304-1" tabindex="-1"></a><span class="fu">qplot</span>(<span class="at">data=</span>air3, <span class="at">x =</span> date, <span class="at">y =</span> ln_pass, <span class="at">geom =</span> <span class="st">&#39;line&#39;</span>)</span></code></pre></div>
<pre><code>## Don&#39;t know how to automatically pick scale for object of type &lt;ts&gt;. Defaulting to continuous.</code></pre>
<p><img src="_main_files/figure-html/08-missing-14-1.png" width="672" /></p>
<p>Make a couple of anomalies to try to identify them.</p>
<div class="sourceCode" id="cb306"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb306-1"><a href="missing-values-anomalies-structural-shift.html#cb306-1" tabindex="-1"></a>air4 <span class="ot">&lt;-</span> air3 <span class="sc">|&gt;</span> <span class="fu">mutate</span>(<span class="at">ln_pass_an =</span> ln_pass)</span>
<span id="cb306-2"><a href="missing-values-anomalies-structural-shift.html#cb306-2" tabindex="-1"></a>air4<span class="sc">$</span>ln_pass_an[<span class="dv">30</span>] <span class="ot">=</span> <span class="dv">6</span></span>
<span id="cb306-3"><a href="missing-values-anomalies-structural-shift.html#cb306-3" tabindex="-1"></a>air4<span class="sc">$</span>ln_pass_an[<span class="dv">110</span>] <span class="ot">=</span> <span class="fl">5.3</span></span>
<span id="cb306-4"><a href="missing-values-anomalies-structural-shift.html#cb306-4" tabindex="-1"></a></span>
<span id="cb306-5"><a href="missing-values-anomalies-structural-shift.html#cb306-5" tabindex="-1"></a><span class="fu">qplot</span>(<span class="at">data=</span>air4, <span class="at">x =</span> date, <span class="at">y =</span> ln_pass_an, <span class="at">geom =</span> <span class="st">&#39;line&#39;</span>)</span></code></pre></div>
<pre><code>## Don&#39;t know how to automatically pick scale for object of type &lt;ts&gt;. Defaulting to continuous.</code></pre>
<p><img src="_main_files/figure-html/08-missing-15-1.png" width="672" /></p>
<p>Run a STL decomposition to identify anomalies.</p>
<div class="sourceCode" id="cb308"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb308-1"><a href="missing-values-anomalies-structural-shift.html#cb308-1" tabindex="-1"></a>decomp <span class="ot">&lt;-</span> <span class="fu">time_decompose</span>(air4, <span class="at">target =</span> ln_pass_an, <span class="at">frequency =</span> <span class="dv">12</span>)</span></code></pre></div>
<pre><code>## Converting from tbl_df to tbl_time.
## Auto-index message: index = date</code></pre>
<pre><code>## frequency = 12 months</code></pre>
<pre><code>## trend = 36 months</code></pre>
<div class="sourceCode" id="cb312"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb312-1"><a href="missing-values-anomalies-structural-shift.html#cb312-1" tabindex="-1"></a>decomp</span></code></pre></div>
<pre><code>## # A time tibble: 144 × 5
## # Index:         date
##    date       observed   season trend remainder
##    &lt;date&gt;        &lt;dbl&gt;    &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;
##  1 1949-01-01     4.72 -0.0826   4.76  0.0440  
##  2 1949-02-01     4.77 -0.103    4.77  0.106   
##  3 1949-03-01     4.88  0.0176   4.78  0.0866  
##  4 1949-04-01     4.86 -0.0205   4.79  0.0909  
##  5 1949-05-01     4.80 -0.00533  4.80  0.000921
##  6 1949-06-01     4.91  0.116    4.81 -0.0224  
##  7 1949-07-01     5.00  0.218    4.82 -0.0427  
##  8 1949-08-01     5.00  0.203    4.83 -0.0393  
##  9 1949-09-01     4.91  0.0603   4.84  0.00788 
## 10 1949-10-01     4.78 -0.0772   4.86  0.000617
## # ℹ 134 more rows</code></pre>
<p>Identify anomalies by reminder component.</p>
<div class="sourceCode" id="cb314"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb314-1"><a href="missing-values-anomalies-structural-shift.html#cb314-1" tabindex="-1"></a>decomp2 <span class="ot">&lt;-</span> <span class="fu">anomalize</span>(decomp, <span class="at">target =</span> remainder)</span>
<span id="cb314-2"><a href="missing-values-anomalies-structural-shift.html#cb314-2" tabindex="-1"></a></span>
<span id="cb314-3"><a href="missing-values-anomalies-structural-shift.html#cb314-3" tabindex="-1"></a><span class="fu">glimpse</span>(decomp2)</span></code></pre></div>
<pre><code>## Rows: 144
## Columns: 8
## Index: date
## $ date         &lt;date&gt; 1949-01-01, 1949-02-01, 1949-03-01, 1949-04-01, 1949-05-01, 1949-06-01, 1949-07-01, 1949-08-01, 1949-09-01, 1949-10-01, 1949-11-01, 1949-12…
## $ observed     &lt;dbl&gt; 4.718499, 4.770685, 4.882802, 4.859812, 4.795791, 4.905275, 4.997212, 4.997212, 4.912655, 4.779123, 4.644391, 4.770685, 4.744932, 4.836282, …
## $ season       &lt;dbl&gt; -0.082643367, -0.103229073, 0.017576244, -0.020530935, -0.005330328, 0.116378118, 0.217623611, 0.203169292, 0.060332081, -0.077241270, -0.22…
## $ trend        &lt;dbl&gt; 4.757105, 4.767879, 4.778653, 4.789426, 4.800200, 4.811261, 4.822322, 4.833383, 4.844443, 4.855747, 4.867051, 4.878355, 4.889659, 4.901442, …
## $ remainder    &lt;dbl&gt; 0.0440367731, 0.1060345664, 0.0865728814, 0.0909168770, 0.0009207448, -0.0223643024, -0.0427331355, -0.0393396512, 0.0078793378, 0.000617403…
## $ remainder_l1 &lt;dbl&gt; -0.1452773, -0.1452773, -0.1452773, -0.1452773, -0.1452773, -0.1452773, -0.1452773, -0.1452773, -0.1452773, -0.1452773, -0.1452773, -0.14527…
## $ remainder_l2 &lt;dbl&gt; 0.1439555, 0.1439555, 0.1439555, 0.1439555, 0.1439555, 0.1439555, 0.1439555, 0.1439555, 0.1439555, 0.1439555, 0.1439555, 0.1439555, 0.143955…
## $ anomaly      &lt;chr&gt; &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;N…</code></pre>
<p><strong>Columns:</strong></p>
<ul>
<li><strong>date:</strong> date of observation</li>
<li><strong>observed:</strong> observed value</li>
<li><strong>season:</strong> seasonal component</li>
<li><strong>trend:</strong> trend component</li>
<li><strong>remainder:</strong> remainder component</li>
<li><strong>remainder_l1:</strong> left bound of the normal value</li>
<li><strong>remainder_l2:</strong> right bound of the normal value</li>
<li><strong>anomaly:</strong> whether the observation is an anomaly or not</li>
</ul>
<p>Plot the anomalies.</p>
<div class="sourceCode" id="cb316"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb316-1"><a href="missing-values-anomalies-structural-shift.html#cb316-1" tabindex="-1"></a>decomp2 <span class="sc">|&gt;</span> <span class="fu">plot_anomalies</span>()</span></code></pre></div>
<p><img src="_main_files/figure-html/08-missing-18-1.png" width="672" /></p>
<p>Recompose the left and right bounds into the original variable (transformed).</p>
<div class="sourceCode" id="cb317"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb317-1"><a href="missing-values-anomalies-structural-shift.html#cb317-1" tabindex="-1"></a>decomp3 <span class="ot">&lt;-</span> <span class="fu">time_recompose</span>(decomp2)</span>
<span id="cb317-2"><a href="missing-values-anomalies-structural-shift.html#cb317-2" tabindex="-1"></a><span class="fu">glimpse</span>(decomp3)</span></code></pre></div>
<pre><code>## Rows: 144
## Columns: 10
## Index: date
## $ date          &lt;date&gt; 1949-01-01, 1949-02-01, 1949-03-01, 1949-04-01, 1949-05-01, 1949-06-01, 1949-07-01, 1949-08-01, 1949-09-01, 1949-10-01, 1949-11-01, 1949-1…
## $ observed      &lt;dbl&gt; 4.718499, 4.770685, 4.882802, 4.859812, 4.795791, 4.905275, 4.997212, 4.997212, 4.912655, 4.779123, 4.644391, 4.770685, 4.744932, 4.836282,…
## $ season        &lt;dbl&gt; -0.082643367, -0.103229073, 0.017576244, -0.020530935, -0.005330328, 0.116378118, 0.217623611, 0.203169292, 0.060332081, -0.077241270, -0.2…
## $ trend         &lt;dbl&gt; 4.757105, 4.767879, 4.778653, 4.789426, 4.800200, 4.811261, 4.822322, 4.833383, 4.844443, 4.855747, 4.867051, 4.878355, 4.889659, 4.901442,…
## $ remainder     &lt;dbl&gt; 0.0440367731, 0.1060345664, 0.0865728814, 0.0909168770, 0.0009207448, -0.0223643024, -0.0427331355, -0.0393396512, 0.0078793378, 0.00061740…
## $ remainder_l1  &lt;dbl&gt; -0.1452773, -0.1452773, -0.1452773, -0.1452773, -0.1452773, -0.1452773, -0.1452773, -0.1452773, -0.1452773, -0.1452773, -0.1452773, -0.1452…
## $ remainder_l2  &lt;dbl&gt; 0.1439555, 0.1439555, 0.1439555, 0.1439555, 0.1439555, 0.1439555, 0.1439555, 0.1439555, 0.1439555, 0.1439555, 0.1439555, 0.1439555, 0.14395…
## $ anomaly       &lt;chr&gt; &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;…
## $ recomposed_l1 &lt;dbl&gt; 4.529185, 4.519373, 4.650952, 4.623618, 4.649593, 4.782362, 4.894668, 4.891275, 4.759498, 4.633229, 4.501086, 4.627661, 4.661738, 4.652935,…
## $ recomposed_l2 &lt;dbl&gt; 4.818418, 4.808606, 4.940185, 4.912851, 4.938825, 5.071595, 5.183901, 5.180507, 5.048731, 4.922462, 4.790319, 4.916894, 4.950971, 4.942168,…</code></pre>
<p>Plot the decomposition.</p>
<div class="sourceCode" id="cb319"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb319-1"><a href="missing-values-anomalies-structural-shift.html#cb319-1" tabindex="-1"></a><span class="fu">plot_anomaly_decomposition</span>(decomp2)</span></code></pre></div>
<p><img src="_main_files/figure-html/08-missing-20-1.png" width="672" /></p>
<p>Clean the data into the origin series (transformed).</p>
<div class="sourceCode" id="cb320"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb320-1"><a href="missing-values-anomalies-structural-shift.html#cb320-1" tabindex="-1"></a>decomp4 <span class="ot">&lt;-</span> <span class="fu">clean_anomalies</span>(decomp3)</span>
<span id="cb320-2"><a href="missing-values-anomalies-structural-shift.html#cb320-2" tabindex="-1"></a><span class="fu">glimpse</span>(decomp4)</span></code></pre></div>
<pre><code>## Rows: 144
## Columns: 11
## Index: date
## $ date             &lt;date&gt; 1949-01-01, 1949-02-01, 1949-03-01, 1949-04-01, 1949-05-01, 1949-06-01, 1949-07-01, 1949-08-01, 1949-09-01, 1949-10-01, 1949-11-01, 194…
## $ observed         &lt;dbl&gt; 4.718499, 4.770685, 4.882802, 4.859812, 4.795791, 4.905275, 4.997212, 4.997212, 4.912655, 4.779123, 4.644391, 4.770685, 4.744932, 4.8362…
## $ season           &lt;dbl&gt; -0.082643367, -0.103229073, 0.017576244, -0.020530935, -0.005330328, 0.116378118, 0.217623611, 0.203169292, 0.060332081, -0.077241270, -…
## $ trend            &lt;dbl&gt; 4.757105, 4.767879, 4.778653, 4.789426, 4.800200, 4.811261, 4.822322, 4.833383, 4.844443, 4.855747, 4.867051, 4.878355, 4.889659, 4.9014…
## $ remainder        &lt;dbl&gt; 0.0440367731, 0.1060345664, 0.0865728814, 0.0909168770, 0.0009207448, -0.0223643024, -0.0427331355, -0.0393396512, 0.0078793378, 0.00061…
## $ remainder_l1     &lt;dbl&gt; -0.1452773, -0.1452773, -0.1452773, -0.1452773, -0.1452773, -0.1452773, -0.1452773, -0.1452773, -0.1452773, -0.1452773, -0.1452773, -0.1…
## $ remainder_l2     &lt;dbl&gt; 0.1439555, 0.1439555, 0.1439555, 0.1439555, 0.1439555, 0.1439555, 0.1439555, 0.1439555, 0.1439555, 0.1439555, 0.1439555, 0.1439555, 0.14…
## $ anomaly          &lt;chr&gt; &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;, &quot;No&quot;…
## $ recomposed_l1    &lt;dbl&gt; 4.529185, 4.519373, 4.650952, 4.623618, 4.649593, 4.782362, 4.894668, 4.891275, 4.759498, 4.633229, 4.501086, 4.627661, 4.661738, 4.6529…
## $ recomposed_l2    &lt;dbl&gt; 4.818418, 4.808606, 4.940185, 4.912851, 4.938825, 5.071595, 5.183901, 5.180507, 5.048731, 4.922462, 4.790319, 4.916894, 4.950971, 4.9421…
## $ observed_cleaned &lt;dbl&gt; 4.718499, 4.770685, 4.882802, 4.859812, 4.795791, 4.905275, 4.997212, 4.997212, 4.912655, 4.779123, 4.644391, 4.770685, 4.744932, 4.8362…</code></pre>
<p>The data are now without anomalies.</p>
<div class="sourceCode" id="cb322"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb322-1"><a href="missing-values-anomalies-structural-shift.html#cb322-1" tabindex="-1"></a><span class="fu">qplot</span>(<span class="at">data=</span>decomp4, <span class="at">x =</span> date, <span class="at">y =</span> observed_cleaned, <span class="at">geom =</span> <span class="st">&#39;line&#39;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/08-missing-22-1.png" width="672" /></p>
</div>
<div id="structural-shift" class="section level2 hasAnchor" number="8.3">
<h2><span class="header-section-number">8.3</span> Structural shift<a href="missing-values-anomalies-structural-shift.html#structural-shift" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb323"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb323-1"><a href="missing-values-anomalies-structural-shift.html#cb323-1" tabindex="-1"></a><span class="fu">library</span>(changepoint)</span></code></pre></div>
<div class="sourceCode" id="cb324"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb324-1"><a href="missing-values-anomalies-structural-shift.html#cb324-1" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">import</span>(<span class="st">&#39;https://github.com/akarlinsky/world_mortality/raw/main/world_mortality.csv&#39;</span>)</span>
<span id="cb324-2"><a href="missing-values-anomalies-structural-shift.html#cb324-2" tabindex="-1"></a><span class="fu">glimpse</span>(m)</span></code></pre></div>
<pre><code>## Rows: 33,283
## Columns: 6
## $ iso3c        &lt;chr&gt; &quot;ALB&quot;, &quot;ALB&quot;, &quot;ALB&quot;, &quot;ALB&quot;, &quot;ALB&quot;, &quot;ALB&quot;, &quot;ALB&quot;, &quot;ALB&quot;, &quot;ALB&quot;, &quot;ALB&quot;, &quot;ALB&quot;, &quot;ALB&quot;, &quot;ALB&quot;, &quot;ALB&quot;, &quot;ALB&quot;, &quot;ALB&quot;, &quot;ALB&quot;, &quot;ALB&quot;, &quot;ALB&quot;, &quot;ALB&quot;, …
## $ country_name &lt;chr&gt; &quot;Albania&quot;, &quot;Albania&quot;, &quot;Albania&quot;, &quot;Albania&quot;, &quot;Albania&quot;, &quot;Albania&quot;, &quot;Albania&quot;, &quot;Albania&quot;, &quot;Albania&quot;, &quot;Albania&quot;, &quot;Albania&quot;, &quot;Albania&quot;, &quot;Albania…
## $ year         &lt;int&gt; 2015, 2015, 2015, 2015, 2015, 2015, 2015, 2015, 2015, 2015, 2015, 2015, 2016, 2016, 2016, 2016, 2016, 2016, 2016, 2016, 2016, 2016, 2016, 20…
## $ time         &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 1, 2, 3, 4, 5, 6, 7, 8,…
## $ time_unit    &lt;chr&gt; &quot;monthly&quot;, &quot;monthly&quot;, &quot;monthly&quot;, &quot;monthly&quot;, &quot;monthly&quot;, &quot;monthly&quot;, &quot;monthly&quot;, &quot;monthly&quot;, &quot;monthly&quot;, &quot;monthly&quot;, &quot;monthly&quot;, &quot;monthly&quot;, &quot;monthly…
## $ deaths       &lt;dbl&gt; 2490, 2139, 2051, 1906, 1709, 1561, 2008, 1687, 1569, 1560, 1728, 2010, 2065, 1905, 1910, 1652, 1716, 1678, 1643, 1578, 1459, 1743, 1855, 21…</code></pre>
<div class="sourceCode" id="cb326"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb326-1"><a href="missing-values-anomalies-structural-shift.html#cb326-1" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> m <span class="sc">|&gt;</span></span>
<span id="cb326-2"><a href="missing-values-anomalies-structural-shift.html#cb326-2" tabindex="-1"></a>  <span class="fu">filter</span>(time_unit <span class="sc">==</span> <span class="st">&#39;monthly&#39;</span>, country_name <span class="sc">==</span> <span class="st">&#39;Russia&#39;</span>) <span class="sc">|&gt;</span></span>
<span id="cb326-3"><a href="missing-values-anomalies-structural-shift.html#cb326-3" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">ymd</span>(<span class="fu">paste0</span>(year, <span class="st">&#39;-&#39;</span>, time, <span class="st">&#39;-01&#39;</span>))) <span class="sc">|&gt;</span></span>
<span id="cb326-4"><a href="missing-values-anomalies-structural-shift.html#cb326-4" tabindex="-1"></a>  <span class="fu">select</span>(date, deaths)</span>
<span id="cb326-5"><a href="missing-values-anomalies-structural-shift.html#cb326-5" tabindex="-1"></a></span>
<span id="cb326-6"><a href="missing-values-anomalies-structural-shift.html#cb326-6" tabindex="-1"></a><span class="fu">qplot</span>(<span class="at">data =</span> m2, <span class="at">x =</span> date, <span class="at">y =</span> deaths, <span class="at">geom =</span> <span class="st">&#39;line&#39;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/08-missing-25-1.png" width="672" /></p>
<p>Make a STL decomposition.</p>
<div class="sourceCode" id="cb327"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb327-1"><a href="missing-values-anomalies-structural-shift.html#cb327-1" tabindex="-1"></a>nm3 <span class="ot">&lt;-</span> m2 <span class="sc">|&gt;</span></span>
<span id="cb327-2"><a href="missing-values-anomalies-structural-shift.html#cb327-2" tabindex="-1"></a>  <span class="fu">as_tbl_time</span>(<span class="at">index =</span> date)</span>
<span id="cb327-3"><a href="missing-values-anomalies-structural-shift.html#cb327-3" tabindex="-1"></a></span>
<span id="cb327-4"><a href="missing-values-anomalies-structural-shift.html#cb327-4" tabindex="-1"></a>decomp <span class="ot">&lt;-</span> <span class="fu">time_decompose</span>(nm3, <span class="at">target =</span> deaths)</span></code></pre></div>
<pre><code>## frequency = 12 months</code></pre>
<pre><code>## trend = 58.5 months</code></pre>
<div class="sourceCode" id="cb330"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb330-1"><a href="missing-values-anomalies-structural-shift.html#cb330-1" tabindex="-1"></a>decomp</span></code></pre></div>
<pre><code>## # A time tibble: 117 × 5
## # Index:         date
##    date       observed season   trend remainder
##    &lt;date&gt;        &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;
##  1 2015-01-01  176304. 18808. 160750.    -3254.
##  2 2015-02-01  158060. -4507. 160503.     2063.
##  3 2015-03-01  173232.  5253. 160257.     7722.
##  4 2015-04-01  161394. -2331. 160011.     3714.
##  5 2015-05-01  163293   4958. 159765.    -1430.
##  6 2015-06-01  154992. -5279. 159519.      753.
##  7 2015-07-01  152969. -4278. 159273.    -2026.
##  8 2015-08-01  152152. -5196. 159028.    -1679.
##  9 2015-09-01  148653. -6230. 158783.    -3900.
## 10 2015-10-01  158130.   260. 158538.     -669.
## # ℹ 107 more rows</code></pre>
<p>Find a structural shift.</p>
<div class="sourceCode" id="cb332"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb332-1"><a href="missing-values-anomalies-structural-shift.html#cb332-1" tabindex="-1"></a><span class="co"># AMOC = At Most One Changepoint</span></span>
<span id="cb332-2"><a href="missing-values-anomalies-structural-shift.html#cb332-2" tabindex="-1"></a>one_break <span class="ot">&lt;-</span> <span class="fu">cpt.mean</span>(nm3<span class="sc">$</span>deaths, <span class="at">method =</span> <span class="st">&#39;AMOC&#39;</span>)</span>
<span id="cb332-3"><a href="missing-values-anomalies-structural-shift.html#cb332-3" tabindex="-1"></a></span>
<span id="cb332-4"><a href="missing-values-anomalies-structural-shift.html#cb332-4" tabindex="-1"></a>one_break</span></code></pre></div>
<pre><code>## Class &#39;cpt&#39; : Changepoint Object
##        ~~   : S4 class containing 12 slots with names
##               cpttype date version data.set method test.stat pen.type pen.value minseglen cpts ncpts.max param.est 
## 
## Created on  : Fri Dec 13 17:45:26 2024 
## 
## summary(.)  :
## ----------
## Created Using changepoint version 2.3 
## Changepoint type      : Change in mean 
## Method of analysis    : AMOC 
## Test Statistic  : Normal 
## Type of penalty       : MBIC with value, 14.28652 
## Minimum Segment Length : 1 
## Maximum no. of cpts   : 1 
## Changepoint Locations : 64</code></pre>
<p>Look at the structural shift.</p>
<div class="sourceCode" id="cb334"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb334-1"><a href="missing-values-anomalies-structural-shift.html#cb334-1" tabindex="-1"></a>nm3[<span class="dv">64</span>, ]</span></code></pre></div>
<pre><code>## # A time tibble: 1 × 2
## # Index:         date
##   date        deaths
##   &lt;date&gt;       &lt;dbl&gt;
## 1 2020-04-01 152500.</code></pre>
<p>Plot the structural shift.</p>
<div class="sourceCode" id="cb336"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb336-1"><a href="missing-values-anomalies-structural-shift.html#cb336-1" tabindex="-1"></a><span class="fu">plot</span>(one_break)</span></code></pre></div>
<p><img src="_main_files/figure-html/08-missing-30-1.png" width="672" /></p>
<div class="sourceCode" id="cb337"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb337-1"><a href="missing-values-anomalies-structural-shift.html#cb337-1" tabindex="-1"></a><span class="co"># =&gt; Assumption: The structural shift because of the COVID</span></span></code></pre></div>
<p>Apply 3 structural shifts searching.</p>
<div class="sourceCode" id="cb338"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb338-1"><a href="missing-values-anomalies-structural-shift.html#cb338-1" tabindex="-1"></a><span class="co"># BigSeg = Binary Segmentation</span></span>
<span id="cb338-2"><a href="missing-values-anomalies-structural-shift.html#cb338-2" tabindex="-1"></a>all_breaks <span class="ot">&lt;-</span> <span class="fu">cpt.mean</span>(nm3<span class="sc">$</span>deaths, <span class="at">method =</span> <span class="st">&#39;BinSeg&#39;</span>, <span class="at">Q =</span> <span class="dv">3</span>)</span></code></pre></div>
<pre><code>## Warning in BINSEG(sumstat, pen = pen.value, cost_func = costfunc, minseglen = minseglen, : The number of changepoints identified is Q, it is advised to increase Q
## to make sure changepoints have not been missed.</code></pre>
<div class="sourceCode" id="cb340"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb340-1"><a href="missing-values-anomalies-structural-shift.html#cb340-1" tabindex="-1"></a>all_breaks</span></code></pre></div>
<pre><code>## Class &#39;cpt&#39; : Changepoint Object
##        ~~   : S4 class containing 14 slots with names
##               cpts.full pen.value.full data.set cpttype method test.stat pen.type pen.value minseglen cpts ncpts.max param.est date version 
## 
## Created on  : Fri Dec 13 17:45:27 2024 
## 
## summary(.)  :
## ----------
## Created Using changepoint version 2.3 
## Changepoint type      : Change in mean 
## Method of analysis    : BinSeg 
## Test Statistic  : Normal 
## Type of penalty       : MBIC with value, 14.28652 
## Minimum Segment Length : 1 
## Maximum no. of cpts   : 3 
## Changepoint Locations : 64 69 87 
## Range of segmentations:
##      [,1] [,2] [,3]
## [1,]   64   NA   NA
## [2,]   64   87   NA
## [3,]   64   87   69
## 
##  For penalty values: 6899445638 6899445638 5101474826</code></pre>
<div class="sourceCode" id="cb342"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb342-1"><a href="missing-values-anomalies-structural-shift.html#cb342-1" tabindex="-1"></a><span class="fu">plot</span>(all_breaks)</span></code></pre></div>
<p><img src="_main_files/figure-html/08-missing-31-1.png" width="672" /></p>
<p>Apply to decomposed series.</p>
<div class="sourceCode" id="cb343"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb343-1"><a href="missing-values-anomalies-structural-shift.html#cb343-1" tabindex="-1"></a><span class="co"># AMOC = At Most One Changepoint </span></span>
<span id="cb343-2"><a href="missing-values-anomalies-structural-shift.html#cb343-2" tabindex="-1"></a>one_break <span class="ot">&lt;-</span> <span class="fu">cpt.mean</span>(decomp<span class="sc">$</span>remainder, <span class="at">method =</span> <span class="st">&#39;AMOC&#39;</span>)</span>
<span id="cb343-3"><a href="missing-values-anomalies-structural-shift.html#cb343-3" tabindex="-1"></a>one_break</span></code></pre></div>
<pre><code>## Class &#39;cpt&#39; : Changepoint Object
##        ~~   : S4 class containing 12 slots with names
##               cpttype date version data.set method test.stat pen.type pen.value minseglen cpts ncpts.max param.est 
## 
## Created on  : Fri Dec 13 17:45:27 2024 
## 
## summary(.)  :
## ----------
## Created Using changepoint version 2.3 
## Changepoint type      : Change in mean 
## Method of analysis    : AMOC 
## Test Statistic  : Normal 
## Type of penalty       : MBIC with value, 14.28652 
## Minimum Segment Length : 1 
## Maximum no. of cpts   : 1 
## Changepoint Locations : 64</code></pre>
<div class="sourceCode" id="cb345"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb345-1"><a href="missing-values-anomalies-structural-shift.html#cb345-1" tabindex="-1"></a><span class="fu">plot</span>(one_break)</span></code></pre></div>
<p><img src="_main_files/figure-html/08-missing-32-1.png" width="672" /></p>
</div>
<div id="bayesian-structural-model" class="section level2 hasAnchor" number="8.4">
<h2><span class="header-section-number">8.4</span> Bayesian Structural Model<a href="missing-values-anomalies-structural-shift.html#bayesian-structural-model" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb346"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb346-1"><a href="missing-values-anomalies-structural-shift.html#cb346-1" tabindex="-1"></a><span class="fu">library</span>(bsts)</span></code></pre></div>
<p>Plot the data.</p>
<div class="sourceCode" id="cb347"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb347-1"><a href="missing-values-anomalies-structural-shift.html#cb347-1" tabindex="-1"></a><span class="fu">plot</span>(AirPassengers)</span></code></pre></div>
<p><img src="_main_files/figure-html/08-missing-34-1.png" width="672" /></p>
<p>Log the data to stabilize the variance.</p>
<div class="sourceCode" id="cb348"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb348-1"><a href="missing-values-anomalies-structural-shift.html#cb348-1" tabindex="-1"></a>log_air <span class="ot">&lt;-</span> <span class="fu">log</span>(AirPassengers)</span>
<span id="cb348-2"><a href="missing-values-anomalies-structural-shift.html#cb348-2" tabindex="-1"></a><span class="fu">plot</span>(log_air)</span></code></pre></div>
<p><img src="_main_files/figure-html/08-missing-35-1.png" width="672" /></p>
<p>Observations:</p>
<ul>
<li>Stable variance of the transformed data</li>
<li>There is a linear trend</li>
<li>There is a seasonality</li>
</ul>
<p><strong>Step by step:</strong><br />
</p>
<ol style="list-style-type: decimal">
<li>Create an empty list</li>
</ol>
<div class="sourceCode" id="cb349"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb349-1"><a href="missing-values-anomalies-structural-shift.html#cb349-1" tabindex="-1"></a>model <span class="ot">=</span> <span class="fu">list</span>()</span></code></pre></div>
<ol start="2" style="list-style-type: decimal">
<li>Add a trend</li>
</ol>
<div class="sourceCode" id="cb350"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb350-1"><a href="missing-values-anomalies-structural-shift.html#cb350-1" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">AddLocalLinearTrend</span>(model, <span class="at">y =</span> log_air)</span></code></pre></div>
<ol start="3" style="list-style-type: decimal">
<li>Add a season</li>
</ol>
<div class="sourceCode" id="cb351"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb351-1"><a href="missing-values-anomalies-structural-shift.html#cb351-1" tabindex="-1"></a>model <span class="ot">&lt;-</span> <span class="fu">AddTrig</span>(model, <span class="at">y =</span> log_air, <span class="at">period =</span> <span class="dv">12</span>, <span class="at">frequencies =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>)</span></code></pre></div>
<ol start="4" style="list-style-type: decimal">
<li>Run generation</li>
</ol>
<div class="sourceCode" id="cb352"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb352-1"><a href="missing-values-anomalies-structural-shift.html#cb352-1" tabindex="-1"></a>poster <span class="ot">&lt;-</span> <span class="fu">bsts</span>(log_air, <span class="at">state.specification =</span> model, <span class="at">niter =</span> <span class="dv">2000</span>)</span></code></pre></div>
<pre><code>## =-=-=-=-= Iteration 0 Fri Dec 13 17:45:27 2024 =-=-=-=-=
## =-=-=-=-= Iteration 200 Fri Dec 13 17:45:29 2024 =-=-=-=-=
## =-=-=-=-= Iteration 400 Fri Dec 13 17:45:30 2024 =-=-=-=-=
## =-=-=-=-= Iteration 600 Fri Dec 13 17:45:32 2024 =-=-=-=-=
## =-=-=-=-= Iteration 800 Fri Dec 13 17:45:34 2024 =-=-=-=-=
## =-=-=-=-= Iteration 1000 Fri Dec 13 17:45:35 2024 =-=-=-=-=
## =-=-=-=-= Iteration 1200 Fri Dec 13 17:45:37 2024 =-=-=-=-=
## =-=-=-=-= Iteration 1400 Fri Dec 13 17:45:39 2024 =-=-=-=-=
## =-=-=-=-= Iteration 1600 Fri Dec 13 17:45:40 2024 =-=-=-=-=
## =-=-=-=-= Iteration 1800 Fri Dec 13 17:45:42 2024 =-=-=-=-=</code></pre>
<ol start="5" style="list-style-type: decimal">
<li>Plot the data</li>
</ol>
<div class="sourceCode" id="cb354"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb354-1"><a href="missing-values-anomalies-structural-shift.html#cb354-1" tabindex="-1"></a><span class="fu">plot</span>(poster, <span class="st">&#39;components&#39;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/08-missing-40-1.png" width="672" /></p>
<ol start="6" style="list-style-type: decimal">
<li>Make forecasts.</li>
</ol>
<div class="sourceCode" id="cb355"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb355-1"><a href="missing-values-anomalies-structural-shift.html#cb355-1" tabindex="-1"></a>frst <span class="ot">&lt;-</span> <span class="fu">predict</span>(poster, <span class="at">horizon =</span> <span class="dv">24</span>, <span class="at">quantiles =</span> <span class="fu">c</span>(<span class="fl">0.05</span>, <span class="fl">0.95</span>),</span>
<span id="cb355-2"><a href="missing-values-anomalies-structural-shift.html#cb355-2" tabindex="-1"></a>                <span class="at">burn =</span> <span class="dv">1000</span>)</span>
<span id="cb355-3"><a href="missing-values-anomalies-structural-shift.html#cb355-3" tabindex="-1"></a></span>
<span id="cb355-4"><a href="missing-values-anomalies-structural-shift.html#cb355-4" tabindex="-1"></a>frst<span class="sc">$</span>mean</span></code></pre></div>
<pre><code>##  [1] 6.113840 6.159961 6.166569 6.188670 6.272479 6.411522 6.513412 6.496878 6.366737 6.209076 6.130153 6.150362 6.217765 6.266098 6.276450 6.293505 6.379757
## [18] 6.520091 6.620041 6.602211 6.474237 6.314879 6.233870 6.257077</code></pre>
<div class="sourceCode" id="cb357"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb357-1"><a href="missing-values-anomalies-structural-shift.html#cb357-1" tabindex="-1"></a><span class="fu">plot</span>(frst)</span></code></pre></div>
<p><img src="_main_files/figure-html/08-missing-42-1.png" width="672" /></p>
</div>
<div id="causal-impact" class="section level2 hasAnchor" number="8.5">
<h2><span class="header-section-number">8.5</span> Causal impact<a href="missing-values-anomalies-structural-shift.html#causal-impact" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="sourceCode" id="cb358"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb358-1"><a href="missing-values-anomalies-structural-shift.html#cb358-1" tabindex="-1"></a><span class="fu">library</span>(CausalImpact)</span></code></pre></div>
<div class="sourceCode" id="cb359"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb359-1"><a href="missing-values-anomalies-structural-shift.html#cb359-1" tabindex="-1"></a>m <span class="ot">&lt;-</span> <span class="fu">import</span>(<span class="st">&#39;https://github.com/akarlinsky/world_mortality/raw/main/world_mortality.csv&#39;</span>)</span>
<span id="cb359-2"><a href="missing-values-anomalies-structural-shift.html#cb359-2" tabindex="-1"></a><span class="fu">glimpse</span>(m)</span></code></pre></div>
<pre><code>## Rows: 33,283
## Columns: 6
## $ iso3c        &lt;chr&gt; &quot;ALB&quot;, &quot;ALB&quot;, &quot;ALB&quot;, &quot;ALB&quot;, &quot;ALB&quot;, &quot;ALB&quot;, &quot;ALB&quot;, &quot;ALB&quot;, &quot;ALB&quot;, &quot;ALB&quot;, &quot;ALB&quot;, &quot;ALB&quot;, &quot;ALB&quot;, &quot;ALB&quot;, &quot;ALB&quot;, &quot;ALB&quot;, &quot;ALB&quot;, &quot;ALB&quot;, &quot;ALB&quot;, &quot;ALB&quot;, …
## $ country_name &lt;chr&gt; &quot;Albania&quot;, &quot;Albania&quot;, &quot;Albania&quot;, &quot;Albania&quot;, &quot;Albania&quot;, &quot;Albania&quot;, &quot;Albania&quot;, &quot;Albania&quot;, &quot;Albania&quot;, &quot;Albania&quot;, &quot;Albania&quot;, &quot;Albania&quot;, &quot;Albania…
## $ year         &lt;int&gt; 2015, 2015, 2015, 2015, 2015, 2015, 2015, 2015, 2015, 2015, 2015, 2015, 2016, 2016, 2016, 2016, 2016, 2016, 2016, 2016, 2016, 2016, 2016, 20…
## $ time         &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 1, 2, 3, 4, 5, 6, 7, 8,…
## $ time_unit    &lt;chr&gt; &quot;monthly&quot;, &quot;monthly&quot;, &quot;monthly&quot;, &quot;monthly&quot;, &quot;monthly&quot;, &quot;monthly&quot;, &quot;monthly&quot;, &quot;monthly&quot;, &quot;monthly&quot;, &quot;monthly&quot;, &quot;monthly&quot;, &quot;monthly&quot;, &quot;monthly…
## $ deaths       &lt;dbl&gt; 2490, 2139, 2051, 1906, 1709, 1561, 2008, 1687, 1569, 1560, 1728, 2010, 2065, 1905, 1910, 1652, 1716, 1678, 1643, 1578, 1459, 1743, 1855, 21…</code></pre>
<div class="sourceCode" id="cb361"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb361-1"><a href="missing-values-anomalies-structural-shift.html#cb361-1" tabindex="-1"></a>m2 <span class="ot">&lt;-</span> m <span class="sc">|&gt;</span></span>
<span id="cb361-2"><a href="missing-values-anomalies-structural-shift.html#cb361-2" tabindex="-1"></a>  <span class="fu">filter</span>(time_unit <span class="sc">==</span> <span class="st">&#39;monthly&#39;</span>, country_name <span class="sc">==</span> <span class="st">&#39;Russia&#39;</span>) <span class="sc">|&gt;</span></span>
<span id="cb361-3"><a href="missing-values-anomalies-structural-shift.html#cb361-3" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">ymd</span>(<span class="fu">paste0</span>(year, <span class="st">&#39;-&#39;</span>, time, <span class="st">&#39;-01&#39;</span>))) <span class="sc">|&gt;</span></span>
<span id="cb361-4"><a href="missing-values-anomalies-structural-shift.html#cb361-4" tabindex="-1"></a>  <span class="fu">select</span>(date, deaths)</span>
<span id="cb361-5"><a href="missing-values-anomalies-structural-shift.html#cb361-5" tabindex="-1"></a></span>
<span id="cb361-6"><a href="missing-values-anomalies-structural-shift.html#cb361-6" tabindex="-1"></a><span class="fu">qplot</span>(<span class="at">data =</span> m2, <span class="at">x =</span> date, <span class="at">y =</span> deaths, <span class="at">geom =</span> <span class="st">&#39;line&#39;</span>)</span></code></pre></div>
<p><img src="_main_files/figure-html/08-missing-45-1.png" width="672" /></p>
<div class="sourceCode" id="cb362"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb362-1"><a href="missing-values-anomalies-structural-shift.html#cb362-1" tabindex="-1"></a>start_covid <span class="ot">&lt;-</span> <span class="dv">61</span> <span class="co"># number of observation when the Covid has been started</span></span>
<span id="cb362-2"><a href="missing-values-anomalies-structural-shift.html#cb362-2" tabindex="-1"></a></span>
<span id="cb362-3"><a href="missing-values-anomalies-structural-shift.html#cb362-3" tabindex="-1"></a>impact <span class="ot">&lt;-</span> <span class="fu">CausalImpact</span>(<span class="at">data =</span> m2<span class="sc">$</span>deaths, <span class="at">pre.period =</span> <span class="fu">c</span>(<span class="dv">1</span>, start_covid<span class="dv">-1</span>), </span>
<span id="cb362-4"><a href="missing-values-anomalies-structural-shift.html#cb362-4" tabindex="-1"></a>                       <span class="at">post.period =</span> <span class="fu">c</span>(start_covid, <span class="fu">nrow</span>(m2)))</span></code></pre></div>
<div class="sourceCode" id="cb363"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb363-1"><a href="missing-values-anomalies-structural-shift.html#cb363-1" tabindex="-1"></a>impact</span></code></pre></div>
<pre><code>## Posterior inference {CausalImpact}
## 
##                          Average            Cumulative        
## Actual                   168523             9605784           
## Prediction (s.d.)        154347 (1779)      8797770 (101406)  
## 95% CI                   [151058, 158022]   [8610319, 9007261]
##                                                               
## Absolute effect (s.d.)   14176 (1779)       808014 (101406)   
## 95% CI                   [10500, 17464]     [598523, 995465]  
##                                                               
## Relative effect (s.d.)   9.2% (1.3%)        9.2% (1.3%)       
## 95% CI                   [6.6%, 12%]        [6.6%, 12%]       
## 
## Posterior tail-area probability p:   0.00101
## Posterior prob. of a causal effect:  99.8995%
## 
## For more details, type: summary(impact, &quot;report&quot;)</code></pre>
<div class="sourceCode" id="cb365"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb365-1"><a href="missing-values-anomalies-structural-shift.html#cb365-1" tabindex="-1"></a><span class="fu">plot</span>(impact)</span></code></pre></div>
<p><img src="_main_files/figure-html/08-missing-48-1.png" width="672" /></p>
<div class="sourceCode" id="cb366"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb366-1"><a href="missing-values-anomalies-structural-shift.html#cb366-1" tabindex="-1"></a><span class="fu">summary</span>(impact)</span></code></pre></div>
<pre><code>## Posterior inference {CausalImpact}
## 
##                          Average            Cumulative        
## Actual                   168523             9605784           
## Prediction (s.d.)        154347 (1779)      8797770 (101406)  
## 95% CI                   [151058, 158022]   [8610319, 9007261]
##                                                               
## Absolute effect (s.d.)   14176 (1779)       808014 (101406)   
## 95% CI                   [10500, 17464]     [598523, 995465]  
##                                                               
## Relative effect (s.d.)   9.2% (1.3%)        9.2% (1.3%)       
## 95% CI                   [6.6%, 12%]        [6.6%, 12%]       
## 
## Posterior tail-area probability p:   0.00101
## Posterior prob. of a causal effect:  99.8995%
## 
## For more details, type: summary(impact, &quot;report&quot;)</code></pre>
<div class="sourceCode" id="cb368"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb368-1"><a href="missing-values-anomalies-structural-shift.html#cb368-1" tabindex="-1"></a><span class="fu">summary</span>(impact, <span class="st">&#39;report&#39;</span>)</span></code></pre></div>
<pre><code>## Analysis report {CausalImpact}
## 
## 
## During the post-intervention period, the response variable had an average value of approx. 168.52K. By contrast, in the absence of an intervention, we would have expected an average response of 154.35K. The 95% interval of this counterfactual prediction is [151.06K, 158.02K]. Subtracting this prediction from the observed response yields an estimate of the causal effect the intervention had on the response variable. This effect is 14.18K with a 95% interval of [10.50K, 17.46K]. For a discussion of the significance of this effect, see below.
## 
## Summing up the individual data points during the post-intervention period (which can only sometimes be meaningfully interpreted), the response variable had an overall value of 9.61M. By contrast, had the intervention not taken place, we would have expected a sum of 8.80M. The 95% interval of this prediction is [8.61M, 9.01M].
## 
## The above results are given in terms of absolute numbers. In relative terms, the response variable showed an increase of +9%. The 95% interval of this percentage is [+7%, +12%].
## 
## This means that the positive effect observed during the intervention period is statistically significant and unlikely to be due to random fluctuations. It should be noted, however, that the question of whether this increase also bears substantive significance can only be answered by comparing the absolute effect (14.18K) to the original goal of the underlying intervention.
## 
## The probability of obtaining this effect by chance is very small (Bayesian one-sided tail-area probability p = 0.001). This means the causal effect can be considered statistically significant.</code></pre>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="arima-with-predictors.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="questions-and-answers.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": false,
"twitter": false,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": null,
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": null,
"search": {
"engine": "lunr",
"options": null
},
"toc": {
"collapse": "subsection"
},
"toolbar": {
"position": "fixed"
},
"info": false
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
